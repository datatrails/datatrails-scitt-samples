# NOTICE: If you are familiar with the python eco system you may ignore this file
# Otherwise, it offers some minimal workflow automation using https://taskfile.dev/
version: '3'
vars:
  VENV_DIR: scitt
  # Put this in the root of the repo for vscode autodection
  VENV_DIR: venv

  PACKAGE_NAME: scitt

tasks:

  install:dev:
    desc: Install the package in development mode (in the virtual environment)
    deps:
      - task: venv
    cmds:
      - |
        set -e
        source {{.VENV_DIR}}/bin/activate
        python -m pip install -e .

  audit:
    desc: Audit the code
    deps:
      - task: venv
    cmds:
      - |
        set -e
        source {{.VENV_DIR}}/bin/activate

        pip-audit -r requirements.txt
        
        deactivate

  check:
    desc: Check the style, bug and quality of the code
    deps:
      - task: venv
    cmds:
      - |
        set -e
        source {{.VENV_DIR}}/bin/activate

        python3 --version
        pycodestyle --format=pylint {{.PACKAGE_NAME}} unittests
        python3 -m pylint {{.PACKAGE_NAME}} unittests
        
        deactivate

  clean:
    desc: Clean git repo
    cmds:
      - find -name '*,cover' -type f -delete
      - git clean -fdX

  format:
    desc: Format code using black
    deps:
      - task: venv
    cmds:
      - |
        set -e
        source {{ .VENV_DIR }}/bin/activate

        python3 -m black {{.PACKAGE_NAME}} unittests
        
        deactivate

  unittests:
    desc: Run unittests
    deps:
      - task: venv
    cmds:
      - |
        set -e
        source {{ .VENV_DIR }}/bin/activate

        python3 -m unittest
        
        deactivate

  venv:
    desc: Builds python environment
    cmds: 
      - |
        set -e
        if [ ! -d {{ .VENV_DIR }} ]
        then
            python3 -m venv {{ .VENV_DIR }}
            source {{ .VENV_DIR }}/bin/activate
            python3 -m pip install -qq -r requirements.txt
            python3 -m pip install -qq -r requirements-dev.txt
            deactivate
        fi

  wheel:
    desc: Builds python wheel package
    deps:
      - task: venv
    cmds:
      - |
        set -e
        source {{ .VENV_DIR }}/bin/activate

        python3 -m pip install --upgrade pip
        python3 -m pip install -r requirements-dev.txt
        python3 -m pip install setuptools wheel
        python3 -m build --sdist
        python3 -m build --wheel
        
        deactivate

